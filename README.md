# Rail Ticket Harvester

## Общее описание проекта

Rail Ticket Harvester — это консольное приложение на Java, предназначенное для получения информации о железнодорожных билетах с сайта [Rail Ninja](https://rail.ninja/) через его REST API. Пользователь вводит город отправления, город прибытия и дату поездки, после чего приложение запрашивает данные о доступных билетах и сохраняет их в файл формата CSV. Проект поддерживает маршруты Paris ↔ Lille и Lisbon ↔ Porto, а количество пассажиров фиксировано (1 взрослый). Приложение обрабатывает невалидный ввод, предоставляя пользователю до 3 попыток для каждого параметра, и не завершается при ошибках, позволяя повторить ввод.

## Инструкция по сборке и запуску приложения

### Требования
- **JDK**: 11 или выше
- **Maven**: 3.6.0 или выше
- **Интернет-соединение**: для доступа к API Rail Ninja

### Установка и сборка
1. Склонируйте репозиторий:
   ```bash
   git clone <URL_репозитория>
   cd FireBird
   ```
2. Убедитесь, что Maven установлен. Проверьте версию:
   ```bash
   mvn --version
   ```
3. Соберите проект:
   ```bash
   mvn clean package
   ```
   Это создаст исполняемый JAR-файл в папке `target`, например, `rail-ticket-harvester-1.0-SNAPSHOT.jar`.

### Запуск приложения
1. Запустите приложение:
   ```bash
   java -jar target/FireBirdTask2-0.0.1-SNAPSHOT.jar
   ```
2. Следуйте инструкциям в консоли:
    - Введите город отправления (Paris, Lille, Lisbon, Porto).
    - Введите город прибытия (доступные маршруты: Paris-Lille, Lisbon-Porto).
    - Введите дату поездки в формате `ДД.ММ.ГГГГ` (например, 30.06.2025) или `ГГГГ-ММ-ДД` (например, 2025-06-30).
    - Для выхода введите `exit` в любом поле.
3. При успешном запросе билеты сохраняются в CSV-файл с именем `tickets_<from>_<to>_<date>.csv` в текущей директории.
4. При ошибке ввода или отсутствии билетов программа предложит повторить ввод.

## Подход к получению данных

Приложение использует REST API Rail Ninja для получения информации о билетах. Процесс включает следующие шаги:
1. **Ввод параметров**:
    - Пользователь вводит город отправления, город прибытия и дату поездки.
    - Валидация выполняется в `InputValidator`:
        - Проверяются разрешенные маршруты (Paris-Lille, Lisbon-Porto).
        - Дата проверяется на формат (`ДД.ММ.ГГГГ` или `ГГГГ-ММ-ДД`) и диапазон (от текущей даты до +1 года).
2. **Запрос к API**:
    - `StationIdResolver` преобразует названия городов в идентификаторы станций.
    - `RailNinjaApiTicketService` отправляет HTTP-запросы:
        - Первый запрос к `https://back.rail.ninja/api/v2/timetable` с параметрами маршрута и даты (1 взрослый пассажир).
        - Последующие запросы к `/timetable/batch` с использованием `search_session_id` для получения всех доступных билетов.
    - Используется `java.net.http.HttpClient` для отправки POST-запросов с JSON-телом.
    - Ответы парсятся с помощью `jackson-databind` в объекты `Ticket`.
3. **Экспорт данных**:
    - Полученные билеты преобразуются в CSV с помощью `CsvTicketExporter` (предположительно использует `opencsv`).
    - CSV-файл содержит столбцы: станция отправления, станция прибытия, время отправления, время прибытия, продолжительность поездки, стоимость билета, класс обслуживания (1st Class Seat, Economy Class Seat), тариф билета (Regular, Flexible).

### Зависимости
- `jackson-databind`: Для парсинга JSON-ответов API.
- `opencsv`: Для записи данных в CSV.


### Примечания
- Приложение устойчиво к ошибкам ввода: при неверных данных предоставляется до 3 попыток, после чего пользователь может начать заново.
- Программа не завершает работу при ошибках, а предлагает повторить ввод.
- API-запросы используют заголовки и cookies, соответствующие браузерным запросам, для обхода ограничений Rail Ninja.

## Дополнение: Покупка билетов

Приложение **Rail Ticket Harvester** поддерживает не только поиск и экспорт информации о билетах, но и их покупку через API Rail Ninja.

### Процесс покупки билета

1. **Ввод данных для покупки**  
   После выбора режима покупки пользователь вводит:
    - Желаемое время отправления (формат `HH:mm`).
    - Данные пассажира: имя, фамилия, пол (`mr`/`mrs`), дата рождения.
    - Контактный email.
    - Данные оплаты: номер карты, тип карты (`visa`/`mastercard`), срок действия, CVV/CVC, имя владельца карты, страна (двухбуквенный ISO-код), телефон.

2. **Валидация данных**  
   Все поля проходят проверку на корректность. При ошибках программа не завершает работу, а предлагает повторить ввод.

3. **Отправка запроса на покупку**
    - Формируется запрос к API Rail Ninja с информацией о рейсе, пассажире и оплате.
    - Используется HTTP PUT/POST запрос с JSON-телом, включающим все необходимые данные.
    - В запросах передаются актуальные cookies и ключи API.

4. **Обработка ответа от API**
    - При успешной оплате выводится подтверждение с деталями бронирования.
    - При ошибках оплаты или данных выводится сообщение с описанием проблемы, предлагается повторить ввод.

5. **Результат**
    - Пользователь видит статус операции в консоли.
    - Программа не завершается при ошибках, обеспечивая удобный цикл повторного ввода.

### Технические детали реализации

- Для передачи платежной информации используется DTO-объект `PaymentRequestDto`.
- Запросы выполняются через HTTP-клиент (например, Unirest или `java.net.http.HttpClient`).
- JSON-парсинг и сериализация реализованы с помощью Jackson или Gson.
- Куки и заголовки API передаются с помощью конфигурационного компонента (`CookieConfig`).
- Метод обработки ответа возвращает простой статус оплаты для удобства вывода.

---
Данное дополнение позволяет полноценно использовать приложение для поиска и покупки билетов с удобной обработкой ошибок и без выхода из программы.
